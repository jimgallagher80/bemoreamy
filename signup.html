<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BE MORE AMY — Sign Up</title>
<link rel="stylesheet" href="style.css">

<style>
/* Keep inputs/selects inside their container on mobile (previous working behaviour) */
*, *::before, *::after { box-sizing: border-box; }

.signup-wrap { margin-top: 10px; border:2px solid #000; border-radius:18px; background:#fff; padding:16px; overflow:hidden; }
.form-grid { display:grid; gap:14px; min-width:0; }
.field label { display:block; font-weight:700; margin-bottom:6px; }
.field { min-width:0; }
.field input, .field select {
  width:100%;
  max-width:100%;
  display:block;
  min-width:0;
  padding:12px;
  border:2px solid #000;
  border-radius:14px;
  font-size:16px;
}

.legs-block { border:2px solid rgba(0,0,0,0.12); border-radius:16px; padding:12px; }
.legs-title { font-weight:800; margin-bottom:10px; }

.btn {
  width:100%;
  max-width:100%;
  padding:14px;
  border-radius:16px;
  border:2px solid #000;
  background:#FAEBC8;
  color:#111;
  font-weight:800;
  font-size:16px;
  cursor:pointer;
}

.modal-backdrop {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index: 9999;
}
.modal {
  background:#fff;
  border:2px solid #000;
  border-radius:18px;
  padding:16px;
  max-width:600px;
  width:100%;

  /* FIX: ensure modal never exceeds viewport and scrolls internally */
  max-height: calc(100vh - 80px);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}
.modal button {
  margin-top:10px;
  padding:10px 14px;
  border-radius:14px;
  border:2px solid #000;
  background:#FAEBC8;
  color:#111;
  font-weight:800;
  width:100%;
  max-width:100%;
}

.linkish { text-decoration:underline; font-weight:800; cursor:pointer; }

.intro-text { margin-bottom:16px; line-height:1.4; }
</style>
</head>

<body>

<header class="site-header">
  <div class="header-inner">
    <div class="menu-wrap">
      <button class="menu-button" id="menuBtn">
        <img src="menu.svg" width="22" height="22" alt="Menu">
      </button>
      <nav class="menu-dropdown" id="site-menu">
        <a href="index.html">The Challenge</a>
        <a href="amy.html">About Amy</a>
        <a href="route.html">The Route</a>
        <a href="signup.html">Sign Up</a>
        <a href="signup-status.html">Signup Status</a>
        <a href="charities.html">Charities</a>
        <a href="gallery.html">Gallery</a>
        <a href="contact.html">Contact</a>
      </nav>
    </div>

    <div class="brand">
      <a href="index.html">
        <img class="brand-logo" src="BMAlogo.svg" width="100" alt="Be More Amy">
      </a>
      <div class="brand-text">
        <div class="brand-line brand-title">BE MORE AMY</div>
        <div class="brand-line brand-subtitle">South West Coastal</div>
        <div class="brand-line brand-subtitle">Path Relay Challenge</div>
        <div class="brand-line brand-date">16th to 23rd May 2026</div>
      </div>
    </div>
  </div>
</header>

<main class="page">
<h1>Sign Up</h1>

<div class="intro-text">
  <p>
    Team leaders should sign up using the form below. Once confirmed, you will receive an email with a further link to a form to collect full details of your team, including emergency contacts and other essential information.
  </p>
  <p>
    Before selecting a leg, please check the
    <a href="signup-status.html" class="linkish">list of confirmed signups</a>.
    If you select a leg that is already taken, your interest will be noted should that leg become available.
  </p>
</div>

<div class="signup-wrap">
<form id="signupForm" class="form-grid" novalidate>

  <div class="field">
    <label for="teamLeaderFirstName">Team Leader First Name</label>
    <input id="teamLeaderFirstName" required>
  </div>

  <div class="field">
    <label for="teamLeaderSurname">Team Leader Surname</label>
    <input id="teamLeaderSurname" required>
  </div>

  <div class="field">
    <label for="groupSize">
      Number of people in your group
      <span class="linkish" id="openGroupInfo" aria-label="More information">ⓘ</span>
    </label>
    <input id="groupSize" type="number" inputmode="numeric" min="1" max="100" required>
  </div>

  <div class="field">
    <label for="email">E-mail</label>
    <input id="email" type="email" required>
  </div>

  <div class="field">
    <label for="phone">Phone Number</label>
    <input id="phone" required>
  </div>

  <div class="legs-block">
    <div class="legs-title">Choose your legs</div>
    <div id="legsContainer"></div>
    <div id="takenNotice" style="margin:10px 0 10px; font-weight:700;"></div>
    <button type="button" id="addLegBtn" class="btn">Add Another Leg</button>
  </div>

  <div>
    <input type="checkbox" id="safetyAccepted">
    <label for="safetyAccepted">
      I confirm I have read and agree to the
      <span class="linkish" id="openSafety">safety and logistics information</span>.
    </label>
  </div>

  <button type="submit" class="btn" id="submitBtn">Submit</button>

</form>
</div>
</main>

<!-- Safety & logistics modal -->
<div class="modal-backdrop" id="safetyModal">
  <div class="modal">
    <h2>Safety and Logistics Information</h2>

    <p>
      This is a self-led relay challenge. By signing up, you confirm that you and any team members are responsible for your own safety, planning, navigation, equipment, fitness to take part, and wellbeing throughout your leg(s).
      You should take appropriate precautions for coastal path conditions, weather, tides, and terrain, and you are responsible for following relevant laws and guidance, including road safety where applicable.
    </p>

    <p>
      A kit list will be sent out in advance of the event.
    </p>

    <p>
      Teams should plan their own transport to and from the start and finish of their legs. Whilst there may be transport available to help, this cannot be guaranteed for every single leg transition at this time.
    </p>

    <p>
      The organisers and associated volunteers do not provide supervision, medical cover, or safety support on the route. Participation is voluntary and undertaken at your own risk.
    </p>

    <p>
      Nothing in this notice excludes or limits liability where it would be unlawful to do so.
    </p>

    <button type="button" id="closeSafety">Close</button>
  </div>
</div>

<!-- Group size info modal -->
<div class="modal-backdrop" id="groupInfoModal">
  <div class="modal">
    <h2>Group Information</h2>
    <p>Names, contact details and emergency contact details for all members of the group will be collected later.</p>
    <button type="button" id="closeGroupInfo">Close</button>
  </div>
</div>

<!-- Success modal -->
<div class="modal-backdrop" id="successModal">
  <div class="modal">
    <h2>Thank You</h2>
    <p>Your signup has been received and is now pending approval.</p>
    <p>Click continue to view the current signups.</p>
    <button type="button" id="closeSuccess">Continue</button>
  </div>
</div>

<script>
const form = document.getElementById('signupForm');
const legsContainer = document.getElementById('legsContainer');
const addLegBtn = document.getElementById('addLegBtn');

const teamLeaderFirstName = document.getElementById('teamLeaderFirstName');
const teamLeaderSurname = document.getElementById('teamLeaderSurname');
const email = document.getElementById('email');
const groupSize = document.getElementById('groupSize');
const phone = document.getElementById('phone');
const safetyAccepted = document.getElementById('safetyAccepted');

const TOTAL_LEGS = 68;
let TAKEN_LEGS = new Set();

async function loadTakenLegs() {
  try {
    const res = await fetch('get_taken_legs.php');
    const data = await res.json();
    if (data && data.success && Array.isArray(data.taken_legs)) {
      TAKEN_LEGS = new Set(data.taken_legs.map(n => String(n)));
    } else {
      TAKEN_LEGS = new Set();
    }
  } catch (e) {
    TAKEN_LEGS = new Set();
  }
}

function applyAvailabilityToSelect(selectEl) {
  Array.from(selectEl.options).forEach(opt => {
    if (!opt.value) return;
    if (!opt.dataset.baseText) opt.dataset.baseText = opt.textContent;
    const taken = TAKEN_LEGS.has(String(opt.value));
    opt.textContent = opt.dataset.baseText + (taken ? ' - Taken' : ' - Available');
  });
}

function refreshTakenNotice() {
  const notice = document.getElementById('takenNotice');
  const selected = legSelects.map(s => s.value).filter(Boolean);
  const takenSelected = selected.filter(v => TAKEN_LEGS.has(String(v)));

  if (!notice) return;

  if (takenSelected.length === 0) {
    notice.textContent = '';
    return;
  }

  const uniq = Array.from(new Set(takenSelected.map(v => String(v)))).sort((a,b)=>parseInt(a,10)-parseInt(b,10));
  notice.textContent = `Leg${uniq.length > 1 ? 's' : ''} ${uniq.join(', ')} ${uniq.length > 1 ? 'are' : 'is'} already taken. If you proceed with this selection, your interest will be noted should it become available.`;
}

/* Only used to generate the dropdown labels (kept as-is) */
const LEG_INFO = window.LEG_INFO || {};

function createLegSelect(){
  const wrap = document.createElement('div');
  wrap.style.marginBottom = '10px';

  const sel = document.createElement('select');
  sel.required = true;
  sel.innerHTML = '<option value="">Select a leg…</option>';

  for (let i=1; i<=TOTAL_LEGS; i++){
    const info = LEG_INFO[String(i)];
    const opt = document.createElement('option');
    opt.value = String(i);

    if (info && info.start && info.end && info.setoff && info.finish) {
      opt.textContent = `${i}: ${info.start} → ${info.end} (${info.setoff} to ${info.finish})`;
    } else {
      opt.textContent = `Leg ${i}`;
    }

    sel.appendChild(opt);
  }

  wrap.appendChild(sel);
  return { wrap, sel };
}

const legSelects = [];

function addLeg(){
  const { wrap, sel } = createLegSelect();
  legsContainer.appendChild(wrap);
  legSelects.push(sel);

  applyAvailabilityToSelect(sel);
  sel.addEventListener('change', refreshTakenNotice);
  refreshTakenNotice();
}

(async () => {
  await loadTakenLegs();
  addLeg();
  refreshTakenNotice();
})();

addLegBtn.addEventListener('click', () => addLeg());

/* modals */
const safetyModal = document.getElementById('safetyModal');
document.getElementById('openSafety').addEventListener('click', () => { safetyModal.style.display='flex'; });
document.getElementById('closeSafety').addEventListener('click', () => { safetyModal.style.display='none'; });

const groupInfoModal = document.getElementById('groupInfoModal');
document.getElementById('openGroupInfo').addEventListener('click', () => { groupInfoModal.style.display='flex'; });
document.getElementById('closeGroupInfo').addEventListener('click', () => { groupInfoModal.style.display='none'; });

const successModal = document.getElementById('successModal');
document.getElementById('closeSuccess').addEventListener('click', () => {
  successModal.style.display='none';
  window.location.href = 'signup-status.html';
});

/* submit */
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  if (!safetyAccepted.checked) {
    safetyModal.style.display = 'flex';
    return;
  }

  const legs = legSelects.map(s => s.value).filter(Boolean);

  const payload = {
    team_leader_first_name: teamLeaderFirstName.value.trim(),
    team_leader_surname: teamLeaderSurname.value.trim(),
    group_size: groupSize.value,
    email: email.value.trim(),
    phone: phone.value.trim(),
    safety_accepted: safetyAccepted.checked ? 1 : 0,
    legs: legs
  };

  try {
    const res = await fetch('submit_signup.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data && data.success) {
      successModal.style.display = 'flex';
      return;
    }

    alert((data && data.error) ? data.error : 'Error submitting form');
  } catch (err) {
    alert('Error submitting form');
  }
});

/* menu */
const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('site-menu');
menuBtn.addEventListener('click', () => {
  menu.classList.toggle('open');
});
document.addEventListener('click', (e) => {
  if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
    menu.classList.remove('open');
  }
});
</script>

</body>
</html>
