<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BE MORE AMY — Sign Up</title>
<link rel="stylesheet" href="style.css">

<style>
/* Keep inputs/selects inside their container on mobile (previous working behaviour) */
*, *::before, *::after { box-sizing: border-box; }

.signup-wrap { margin-top: 10px; border:2px solid #000; border-radius:18px; background:#fff; padding:16px; overflow:hidden; }
.form-grid { display:grid; gap:14px; min-width:0; }
.field label { display:block; font-weight:700; margin-bottom:6px; }
.field { min-width:0; }
.field input, .field select {
  width:100%;
  max-width:100%;
  display:block;
  min-width:0;
  padding:12px;
  border:2px solid #000;
  border-radius:14px;
  font-size:16px;
}

/* iOS Safari: prevent long selected option text from forcing the select wider than its container */
.field select{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.legs-block { border:2px solid rgba(0,0,0,0.12); border-radius:16px; padding:12px; }
.legs-title { font-weight:800; margin-bottom:10px; }

.btn {
  width:100%;
  max-width:100%;
  padding:14px;
  border-radius:16px;
  border:2px solid #000;
  background:#FAEBC8;
  color:#111;
  font-weight:800;
  font-size:16px;
  cursor:pointer;
}

.modal-backdrop {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index: 9999;
}
.modal {
  background:#fff;
  border:2px solid #000;
  border-radius:18px;
  padding:16px;
  max-width:600px;
  width:100%;

  /* FIX: ensure modal never exceeds viewport and scrolls internally */
  max-height: calc(100vh - 80px);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}
.modal button {
  margin-top:10px;
  padding:10px 14px;
  border-radius:14px;
  border:2px solid #000;
  background:#FAEBC8;
  color:#111;
  font-weight:800;
  width:100%;
  max-width:100%;
}

.linkish { text-decoration:underline; font-weight:800; cursor:pointer; }

.intro-text { margin-bottom:16px; line-height:1.4; }

/* Ensure all form controls stay inside the bordered form container (fixes iOS Safari width issue) */
.field input,
.field select,
.field textarea,
.legs-block select{
  width: 100%;
  max-width: 100%;
  display: block;
  min-width: 0;
  box-sizing: border-box;
}

/* Prevent long dropdown text from forcing the select wider on iPhone */
.legs-block select{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

</style>
</head>

<body>

<header class="site-header">
  <div class="header-inner">
    <div class="menu-wrap">
      <button class="menu-button" id="menuBtn">
        <img src="menu.svg" width="22" height="22" alt="Menu">
      </button>
      <nav class="menu-dropdown" id="site-menu">
          <a href="index.html">Home</a>
          <a href="challenge.html">The Challenge</a>
          <a href="amy.html">About Amy</a>
          <a href="route.html">The Route</a>
          <a href="signup.html">Sign Up</a>
          <a href="signup-status.html">Confirmed Teams</a>
          <a href="charities.html">Charities</a> 
          <a href="gallery.html">Gallery</a>
          <a href="contact.html">Contact</a>
    </div>

    <div class="brand">
      <a href="index.html">
        <img class="brand-logo" src="BMAlogo.svg" width="100" alt="Be More Amy">
      </a>
      <div class="brand-text">
        <div class="brand-line brand-title">BE MORE AMY</div>
        <div class="brand-line brand-subtitle">South West Coastal</div>
        <div class="brand-line brand-subtitle">Path Relay Challenge</div>
        <div class="brand-line brand-date">16th to 23rd May 2026</div>
      </div>
    </div>
  </div>
</header>

<main class="page">
<h1>Sign Up</h1>

<div class="intro-text">
  <p>
    Team leaders should sign up using the form below. Once confirmed, you will receive an email with a further link to a form to collect full details of your team, including emergency contacts and other essential information.
  </p>
  <p>
    Before selecting a leg, please check the lust of 
    <a href="signup-status.html" class="linkish">teams that have already confirmed</a>.
    If you select a leg that is already taken, your interest will be noted should that leg become available.
  </p>
</div>

<div class="signup-wrap">
<form id="signupForm" class="form-grid" novalidate>

  <div class="field">
    <label for="teamLeaderFirstName">Team Leader First Name</label>
    <input id="teamLeaderFirstName" required>
  </div>

  <div class="field">
    <label for="teamLeaderSurname">Team Leader Surname</label>
    <input id="teamLeaderSurname" required>
  </div>

  <div class="field">
    <label for="groupSize">
      Number of people in your group
      <span class="linkish" id="openGroupInfo" aria-label="More information">ⓘ</span>
    </label>
    <input id="groupSize" type="number" inputmode="numeric" min="1" max="100" required>
  </div>

  <div class="field">
    <label for="email">E-mail</label>
    <input id="email" type="email" required>
  </div>

  <div class="field">
    <label for="phone">Phone Number</label>
    <input id="phone" required>
  </div>

  <div class="legs-block">
    <div class="legs-title">Choose your legs</div>
    <div id="legsContainer"></div>
    <div id="takenNotice" style="margin:10px 0 10px; font-weight:700;"></div>
    <button type="button" id="addLegBtn" class="btn">Add Another Leg</button>
  </div>

  <div>
    <input type="checkbox" id="safetyAccepted">
    <label for="safetyAccepted">
      I confirm I have read and agree to the
      <span class="linkish" id="openSafety">safety and logistics information</span>.
    </label>
  </div>

  <button type="submit" class="btn" id="submitBtn">Submit</button>

</form>
</div>
</main>

<!-- Safety & logistics modal -->
<div class="modal-backdrop" id="safetyModal">
  <div class="modal">
    <h2>Safety and Logistics Information</h2>

    <p>
      This is a self-led relay challenge. By signing up, you confirm that you and any team members are responsible for your own safety, planning, navigation, equipment, fitness to take part, and wellbeing throughout your leg(s).
      You should take appropriate precautions for coastal path conditions, weather, tides, and terrain, and you are responsible for following relevant laws and guidance, including road safety where applicable.
    </p>

    <p>
      A kit list will be sent out in advance of the event.
    </p>

    <p>
      Teams should plan their own transport to and from the start and finish of their legs. Whilst there may be transport available to help, this cannot be guaranteed for every single leg transition at this time.
    </p>

    <p>
      The organisers and associated volunteers do not provide supervision, medical cover, or safety support on the route. Participation is voluntary and undertaken at your own risk.
    </p>

    <p>
      Nothing in this notice excludes or limits liability where it would be unlawful to do so.
    </p>

    <button type="button" id="closeSafety">Close</button>
  </div>
</div>

<!-- Group size info modal -->
<div class="modal-backdrop" id="groupInfoModal">
  <div class="modal">
    <h2>Group Information</h2>
    <p>Names, contact details and emergency contact details for all members of the group will be collected later.</p>
    <button type="button" id="closeGroupInfo">Close</button>
  </div>
</div>

<!-- Success modal -->
<div class="modal-backdrop" id="successModal">
  <div class="modal">
    <h2>Thank You</h2>
    <p>Your signup has been received and is now pending approval.</p>
    <p>Click continue to view the current signups.</p>
    <button type="button" id="closeSuccess">Continue</button>
  </div>
</div>

<script>
const form = document.getElementById('signupForm');
const legsContainer = document.getElementById('legsContainer');
const addLegBtn = document.getElementById('addLegBtn');

const teamLeaderFirstName = document.getElementById('teamLeaderFirstName');
const teamLeaderSurname = document.getElementById('teamLeaderSurname');
const email = document.getElementById('email');
const groupSize = document.getElementById('groupSize');
const phone = document.getElementById('phone');
const safetyAccepted = document.getElementById('safetyAccepted');

const TOTAL_LEGS = 68;
let TAKEN_LEGS = new Set();

async function loadTakenLegs() {
  try {
    const res = await fetch('get_taken_legs.php');
    const data = await res.json();
    if (data && data.success && Array.isArray(data.taken_legs)) {
      TAKEN_LEGS = new Set(data.taken_legs.map(n => String(n)));
    } else {
      TAKEN_LEGS = new Set();
    }
  } catch (e) {
    TAKEN_LEGS = new Set();
  }
}

function applyAvailabilityToSelect(selectEl) {
  Array.from(selectEl.options).forEach(opt => {
    if (!opt.value) return;
    if (!opt.dataset.baseText) opt.dataset.baseText = opt.textContent;
    const taken = TAKEN_LEGS.has(String(opt.value));
    opt.textContent = opt.dataset.baseText + (taken ? ' - TAKEN' : ' - AVAILABLE');
  });
}

function refreshTakenNotice() {
  const notice = document.getElementById('takenNotice');
  const selected = legSelects.map(s => s.value).filter(Boolean);
  const takenSelected = selected.filter(v => TAKEN_LEGS.has(String(v)));

  if (!notice) return;

  if (takenSelected.length === 0) {
    notice.textContent = '';
    return;
  }

  const uniq = Array.from(new Set(takenSelected.map(v => String(v)))).sort((a,b)=>parseInt(a,10)-parseInt(b,10));
  notice.textContent = `Leg${uniq.length > 1 ? 's' : ''} ${uniq.join(', ')} ${uniq.length > 1 ? 'are' : 'is'} already taken. If you proceed with this selection, your interest will be noted should it become available.`;
}

/* Only used to generate the dropdown labels (kept local to this page) */
const GEOJSON_URL = "ALL_COASTAL_LEGS_ENRICHED.geojson";
const LEG_TIMES = {"1":{"setoff":"Sat 16 May 2026 08:00","finish":"Sat 16 May 2026 10:27"},"2":{"setoff":"Sat 16 May 2026 10:27","finish":"Sat 16 May 2026 13:44"},"3":{"setoff":"Sat 16 May 2026 13:44","finish":"Sat 16 May 2026 16:22"},"4":{"setoff":"Sat 16 May 2026 16:22","finish":"Sat 16 May 2026 18:33"},"5":{"setoff":"Sat 16 May 2026 18:33","finish":"Sat 16 May 2026 20:01"},"6":{"setoff":"Sat 16 May 2026 20:01","finish":"Sat 16 May 2026 21:51"},"7":{"setoff":"Sat 16 May 2026 21:51","finish":"Sat 16 May 2026 23:41"},"8":{"setoff":"Sat 16 May 2026 23:41","finish":"Sun 17 May 2026 02:14"},"9":{"setoff":"Sun 17 May 2026 02:14","finish":"Sun 17 May 2026 04:48"},"10":{"setoff":"Sun 17 May 2026 04:48","finish":"Sun 17 May 2026 07:00"},"11":{"setoff":"Sun 17 May 2026 07:00","finish":"Sun 17 May 2026 09:19"},"12":{"setoff":"Sun 17 May 2026 09:19","finish":"Sun 17 May 2026 11:53"},"13":{"setoff":"Sun 17 May 2026 11:53","finish":"Sun 17 May 2026 15:03"},"14":{"setoff":"Sun 17 May 2026 15:03","finish":"Sun 17 May 2026 16:45"},"15":{"setoff":"Sun 17 May 2026 16:45","finish":"Sun 17 May 2026 19:26"},"16":{"setoff":"Sun 17 May 2026 19:26","finish":"Sun 17 May 2026 21:31"},"17":{"setoff":"Sun 17 May 2026 21:31","finish":"Sun 17 May 2026 23:06"},"18":{"setoff":"Sun 17 May 2026 23:06","finish":"Mon 18 May 2026 01:39"},"19":{"setoff":"Mon 18 May 2026 01:39","finish":"Mon 18 May 2026 04:35"},"20":{"setoff":"Mon 18 May 2026 04:35","finish":"Mon 18 May 2026 07:42"},"21":{"setoff":"Mon 18 May 2026 07:42","finish":"Mon 18 May 2026 10:48"},"22":{"setoff":"Mon 18 May 2026 10:48","finish":"Mon 18 May 2026 12:31"},"23":{"setoff":"Mon 18 May 2026 12:31","finish":"Mon 18 May 2026 14:50"},"24":{"setoff":"Mon 18 May 2026 14:50","finish":"Mon 18 May 2026 17:45"},"25":{"setoff":"Mon 18 May 2026 17:45","finish":"Mon 18 May 2026 19:02"},"26":{"setoff":"Mon 18 May 2026 19:02","finish":"Mon 18 May 2026 21:47"},"27":{"setoff":"Mon 18 May 2026 21:47","finish":"Tue 19 May 2026 00:35"},"28":{"setoff":"Tue 19 May 2026 00:35","finish":"Tue 19 May 2026 04:15"},"29":{"setoff":"Tue 19 May 2026 04:15","finish":"Tue 19 May 2026 06:37"},"30":{"setoff":"Tue 19 May 2026 06:37","finish":"Tue 19 May 2026 09:13"},"31":{"setoff":"Tue 19 May 2026 09:13","finish":"Tue 19 May 2026 12:41"},"32":{"setoff":"Tue 19 May 2026 12:41","finish":"Tue 19 May 2026 14:53"},"33":{"setoff":"Tue 19 May 2026 14:53","finish":"Tue 19 May 2026 16:28"},"34":{"setoff":"Tue 19 May 2026 16:28","finish":"Tue 19 May 2026 19:02"},"35":{"setoff":"Tue 19 May 2026 19:02","finish":"Tue 19 May 2026 21:28"},"36":{"setoff":"Tue 19 May 2026 21:28","finish":"Wed 20 May 2026 00:24"},"37":{"setoff":"Wed 20 May 2026 00:24","finish":"Wed 20 May 2026 03:12"},"38":{"setoff":"Wed 20 May 2026 03:12","finish":"Wed 20 May 2026 06:15"},"39":{"setoff":"Wed 20 May 2026 06:15","finish":"Wed 20 May 2026 08:56"},"40":{"setoff":"Wed 20 May 2026 08:56","finish":"Wed 20 May 2026 11:51"},"41":{"setoff":"Wed 20 May 2026 11:51","finish":"Wed 20 May 2026 14:25"},"42":{"setoff":"Wed 20 May 2026 14:25","finish":"Wed 20 May 2026 16:51"},"43":{"setoff":"Wed 20 May 2026 16:51","finish":"Wed 20 May 2026 20:31"},"44":{"setoff":"Wed 20 May 2026 20:31","finish":"Wed 20 May 2026 22:57"},"45":{"setoff":"Wed 20 May 2026 22:57","finish":"Thu 21 May 2026 01:31"},"46":{"setoff":"Thu 21 May 2026 01:31","finish":"Thu 21 May 2026 04:05"},"47":{"setoff":"Thu 21 May 2026 04:05","finish":"Thu 21 May 2026 07:00"},"48":{"setoff":"Thu 21 May 2026 07:00","finish":"Thu 21 May 2026 09:34"},"49":{"setoff":"Thu 21 May 2026 09:34","finish":"Thu 21 May 2026 12:30"},"50":{"setoff":"Thu 21 May 2026 12:30","finish":"Thu 21 May 2026 14:56"},"51":{"setoff":"Thu 21 May 2026 14:56","finish":"Thu 21 May 2026 17:19"},"52":{"setoff":"Thu 21 May 2026 17:19","finish":"Thu 21 May 2026 20:36"},"53":{"setoff":"Thu 21 May 2026 20:36","finish":"Thu 21 May 2026 22:33"},"54":{"setoff":"Thu 21 May 2026 22:33","finish":"Fri 22 May 2026 00:52"},"55":{"setoff":"Fri 22 May 2026 00:52","finish":"Fri 22 May 2026 03:55"},"56":{"setoff":"Fri 22 May 2026 03:55","finish":"Fri 22 May 2026 07:13"},"57":{"setoff":"Fri 22 May 2026 07:13","finish":"Fri 22 May 2026 09:39"},"58":{"setoff":"Fri 22 May 2026 09:39","finish":"Fri 22 May 2026 12:57"},"59":{"setoff":"Fri 22 May 2026 12:57","finish":"Fri 22 May 2026 15:38"},"60":{"setoff":"Fri 22 May 2026 15:38","finish":"Fri 22 May 2026 17:49"},"61":{"setoff":"Fri 22 May 2026 17:49","finish":"Fri 22 May 2026 20:08"},"62":{"setoff":"Fri 22 May 2026 20:08","finish":"Fri 22 May 2026 22:35"},"63":{"setoff":"Fri 22 May 2026 22:35","finish":"Sat 23 May 2026 01:16"},"64":{"setoff":"Sat 23 May 2026 01:16","finish":"Sat 23 May 2026 04:19"},"65":{"setoff":"Sat 23 May 2026 04:19","finish":"Sat 23 May 2026 07:36"},"66":{"setoff":"Sat 23 May 2026 07:36","finish":"Sat 23 May 2026 10:10"},"67":{"setoff":"Sat 23 May 2026 10:10","finish":"Sat 23 May 2026 12:11"},"68":{"setoff":"Sat 23 May 2026 12:11","finish":"Sat 23 May 2026 14:00"}};

const LEG_INFO = {};

function ordinal(n) {
  const s = ["th","st","nd","rd"];
  const v = n % 100;
  return n + (s[(v-20)%10] || s[v] || s[0]);
}

function formatTimeForOption(dateTimeStr) {
  // "Sat 16 May 2026 08:00" -> "8:00am, 16th May"
  if (!dateTimeStr) return "—";
  const parts = String(dateTimeStr).trim().split(/\s+/);
  if (parts.length < 5) return String(dateTimeStr);

  const dayNum = parseInt(parts[1], 10);
  const mon = parts[2];
  const time = parts[4];

  const hm = time.split(":");
  let hh = parseInt(hm[0], 10);
  const mm = String(hm[1] || "00").padStart(2, "0");
  if (Number.isNaN(hh) || Number.isNaN(dayNum)) return String(dateTimeStr);

  const ampm = hh >= 12 ? "pm" : "am";
  hh = hh % 12;
  if (hh === 0) hh = 12;

  return `${hh}:${mm}${ampm}, ${ordinal(dayNum)} ${mon}`;
}

async function loadLegInfo() {
  try {
    const res = await fetch(GEOJSON_URL, { cache: "no-store" });
    if (!res.ok) return;
    const geo = await res.json();
    if (!geo || !Array.isArray(geo.features)) return;

    geo.features.forEach((f) => {
      const p = (f && f.properties) ? f.properties : null;
      if (!p) return;
      const leg = String(p.leg);
      if (!leg) return;

      const t = LEG_TIMES[leg] || null;

      LEG_INFO[leg] = {
        start: p.start || "—",
        end: p.end || "—",
        setoff: t ? formatTimeForOption(t.setoff) : "—",
        finish: t ? formatTimeForOption(t.finish) : "—"
      };
    });
  } catch (e) {
    // leave LEG_INFO empty
  }
}


function createLegSelect(){
  const wrap = document.createElement('div');
  wrap.style.marginBottom = '10px';

  const sel = document.createElement('select');
  sel.required = true;
  sel.innerHTML = '<option value="">Select a leg…</option>';

  for (let i=1; i<=TOTAL_LEGS; i++){
    const info = LEG_INFO[String(i)];
    const opt = document.createElement('option');
    opt.value = String(i);

    if (info && info.start && info.end && info.setoff && info.finish) {
      opt.textContent = `Leg ${i}: ${info.start} (${info.setoff}) to ${info.end} (${info.finish})`;
    } else {
      opt.textContent = `Leg ${i}`;
    }

    sel.appendChild(opt);
  }

  wrap.appendChild(sel);
  return { wrap, sel };
}

const legSelects = [];

function addLeg(){
  const { wrap, sel } = createLegSelect();
  legsContainer.appendChild(wrap);
  legSelects.push(sel);

  applyAvailabilityToSelect(sel);
  sel.addEventListener('change', refreshTakenNotice);
  refreshTakenNotice();
}

(async () => {
  await loadTakenLegs();
  await loadLegInfo();
  addLeg();
  refreshTakenNotice();
})();

addLegBtn.addEventListener('click', () => addLeg());

/* modals */
const safetyModal = document.getElementById('safetyModal');
document.getElementById('openSafety').addEventListener('click', () => { safetyModal.style.display='flex'; });
document.getElementById('closeSafety').addEventListener('click', () => { safetyModal.style.display='none'; });

const groupInfoModal = document.getElementById('groupInfoModal');
document.getElementById('openGroupInfo').addEventListener('click', () => { groupInfoModal.style.display='flex'; });
document.getElementById('closeGroupInfo').addEventListener('click', () => { groupInfoModal.style.display='none'; });

const successModal = document.getElementById('successModal');
document.getElementById('closeSuccess').addEventListener('click', () => {
  successModal.style.display='none';
  window.location.href = 'signup-status.html';
});

/* submit */
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  if (!safetyAccepted.checked) {
    safetyModal.style.display = 'flex';
    return;
  }

  const legs = legSelects.map(s => s.value).filter(Boolean);

  const payload = {
    team_leader_first_name: teamLeaderFirstName.value.trim(),
    team_leader_surname: teamLeaderSurname.value.trim(),
    group_size: groupSize.value,
    email: email.value.trim(),
    phone: phone.value.trim(),
    safety_accepted: safetyAccepted.checked ? 1 : 0,
    legs: legs
  };

  try {
    const res = await fetch('submit_signup.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data && data.success) {
      successModal.style.display = 'flex';
      return;
    }

    alert((data && data.error) ? data.error : 'Error submitting form');
  } catch (err) {
    alert('Error submitting form');
  }
});

/* menu */
const menuBtn = document.getElementById('menuBtn');
const menu = document.getElementById('site-menu');
menuBtn.addEventListener('click', () => {
  menu.classList.toggle('open');
});
document.addEventListener('click', (e) => {
  if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
    menu.classList.remove('open');
  }
});
</script>

</body>
</html>
